<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>利益計算シート改修 設計書</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 40px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h2 {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        h3 {
            color: #333;
            margin: 20px 0 10px 0;
            font-size: 1.2em;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f8f9ff;
        }
        tr:hover {
            background-color: #e8ebff;
        }
        .flow-diagram {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        .flow-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
            min-width: 150px;
        }
        .flow-arrow {
            font-size: 2em;
            color: #667eea;
        }
        .highlight {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            margin: 15px 0;
        }
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            margin: 15px 0;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        .status-new {
            background: #d4edda;
            color: #155724;
        }
        .status-modify {
            background: #fff3cd;
            color: #856404;
        }
        .status-keep {
            background: #e2e3e5;
            color: #383d41;
        }
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .card {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #667eea;
        }
        .card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .card ul {
            padding-left: 20px;
        }
        .card li {
            margin: 8px 0;
        }
        .tag {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            margin: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>利益計算シート改修 設計書</h1>

        <!-- 1. 概要 -->
        <div class="section">
            <h2>1. 概要</h2>
            <p>EAGLEツールとCpassの送料データを統合し、利益計算を効率化するためのシート改修計画</p>

            <h3>現状の課題</h3>
            <ul>
                <li>EAGLEのCSVフォーマットと現在のシートの列構成が一致していない</li>
                <li>Cpassの送料データ（送料系・関税系）が分散しており、手動集計が必要</li>
                <li>既に入力済みのデータと新規データの重複管理が困難</li>
            </ul>

            <h3>改修目標</h3>
            <ul>
                <li>EAGLEのCSVをそのままインポートできる列構成に変更</li>
                <li>Cpassの送料・関税データを自動集計する仕組みを構築</li>
                <li>重複登録を防ぐ管理機能の実装</li>
                <li>EAGLE更新フォーマットの自動生成</li>
            </ul>
        </div>

        <!-- 2. データフロー -->
        <div class="section">
            <h2>2. データフロー</h2>

            <div class="flow-diagram">
                <div class="flow-box">EAGLE<br>（売上データ）</div>
                <div class="flow-arrow">→</div>
                <div class="flow-box">利益計算シート<br>（メイン）</div>
                <div class="flow-arrow">→</div>
                <div class="flow-box">EAGLE<br>（送料更新）</div>
            </div>

            <div class="flow-diagram">
                <div class="flow-box">Cpass<br>（送料系CSV）</div>
                <div class="flow-arrow">→</div>
                <div class="flow-box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">送料集計シート<br>（新規）</div>
                <div class="flow-arrow">→</div>
                <div class="flow-box">EAGLE更新<br>フォーマット</div>
            </div>

            <div class="flow-diagram">
                <div class="flow-box">Cpass<br>（関税系CSV）</div>
                <div class="flow-arrow">↗</div>
            </div>
        </div>

        <!-- 3. シート構成 -->
        <div class="section">
            <h2>3. シート構成（タブ）</h2>

            <table>
                <tr>
                    <th>シート名</th>
                    <th>用途</th>
                    <th>ステータス</th>
                </tr>
                <tr>
                    <td>売上個別</td>
                    <td>メインの利益計算シート（EAGLE形式に合わせて改修）</td>
                    <td><span class="status-badge status-modify">改修</span></td>
                </tr>
                <tr>
                    <td>送料集計</td>
                    <td>Cpassデータを貼り付け、追跡番号ごとに自動集計</td>
                    <td><span class="status-badge status-new">新規</span></td>
                </tr>
                <tr>
                    <td>EAGLE更新用</td>
                    <td>未登録分の追跡番号と送料+関税を出力</td>
                    <td><span class="status-badge status-new">新規</span></td>
                </tr>
                <tr>
                    <td>売上まとめ</td>
                    <td>既存の集計シート</td>
                    <td><span class="status-badge status-keep">維持</span></td>
                </tr>
            </table>
        </div>

        <!-- 4. 売上個別シート列構成 -->
        <div class="section">
            <h2>4. 売上個別シート 列構成（EAGLE対応）</h2>

            <table>
                <tr>
                    <th>列</th>
                    <th>項目名</th>
                    <th>EAGLE対応</th>
                    <th>備考</th>
                </tr>
                <tr>
                    <td>A</td>
                    <td>id</td>
                    <td>id</td>
                    <td><span class="tag">新規</span> EAGLEのID</td>
                </tr>
                <tr>
                    <td>B</td>
                    <td>注文日</td>
                    <td>注文日</td>
                    <td>旧：売上日（支払日）</td>
                </tr>
                <tr>
                    <td>C</td>
                    <td>注文ID</td>
                    <td>注文ID</td>
                    <td>旧：注文番号</td>
                </tr>
                <tr>
                    <td>D</td>
                    <td>購入者ユーザー名</td>
                    <td>購入者ユーザー名</td>
                    <td>旧：購入者ID</td>
                </tr>
                <tr>
                    <td>E</td>
                    <td>商品名</td>
                    <td>商品名</td>
                    <td>変更なし</td>
                </tr>
                <tr>
                    <td>F</td>
                    <td>単位</td>
                    <td>単位</td>
                    <td><span class="tag">新規</span> USD等</td>
                </tr>
                <tr>
                    <td>G</td>
                    <td>明細小計</td>
                    <td>明細小計</td>
                    <td>旧：売却額（ドル）</td>
                </tr>
                <tr>
                    <td>H</td>
                    <td>明細配送料</td>
                    <td>明細配送料</td>
                    <td>旧：追加送料（ドル）</td>
                </tr>
                <tr>
                    <td>I</td>
                    <td>明細合計</td>
                    <td>明細合計</td>
                    <td>売上ドル合計</td>
                </tr>
                <tr>
                    <td>J</td>
                    <td>明細合計（円）</td>
                    <td>明細合計（円）</td>
                    <td>旧：売却額（円）</td>
                </tr>
                <tr>
                    <td>K</td>
                    <td>仕入先</td>
                    <td>仕入先</td>
                    <td>変更なし</td>
                </tr>
                <tr>
                    <td>L</td>
                    <td>仕入先コード</td>
                    <td>仕入先コード</td>
                    <td><span class="tag">新規</span></td>
                </tr>
                <tr>
                    <td>M</td>
                    <td>仕入先URL</td>
                    <td>仕入先URL</td>
                    <td><span class="tag">新規</span></td>
                </tr>
                <tr>
                    <td>N</td>
                    <td>仕入日</td>
                    <td>仕入日</td>
                    <td>変更なし</td>
                </tr>
                <tr>
                    <td>O</td>
                    <td>仕入価格</td>
                    <td>仕入価格</td>
                    <td>旧：仕入値</td>
                </tr>
                <tr>
                    <td>P</td>
                    <td>仕入時ポイント</td>
                    <td>仕入時ポイント</td>
                    <td>旧：ポイント</td>
                </tr>
                <tr>
                    <td>Q</td>
                    <td>単位（手数料）</td>
                    <td>単位</td>
                    <td>USD等</td>
                </tr>
                <tr>
                    <td>R</td>
                    <td>手数料</td>
                    <td>手数料</td>
                    <td>旧：Total fee</td>
                </tr>
                <tr>
                    <td>S</td>
                    <td>単位（広告費）</td>
                    <td>単位</td>
                    <td>USD等</td>
                </tr>
                <tr>
                    <td>T</td>
                    <td>広告費</td>
                    <td>広告費</td>
                    <td>変更なし</td>
                </tr>
                <tr>
                    <td>U</td>
                    <td>手数料合計(円)</td>
                    <td>手数料合計(円)</td>
                    <td>旧：ebay手数料合計</td>
                </tr>
                <tr>
                    <td>V</td>
                    <td>出金手数料(%)</td>
                    <td>*出金手数料(%)</td>
                    <td>変更なし</td>
                </tr>
                <tr>
                    <td>W</td>
                    <td>出金手数料(円)</td>
                    <td>出金手数料(円)</td>
                    <td>変更なし</td>
                </tr>
                <tr>
                    <td>X</td>
                    <td>送料+関税</td>
                    <td>*送料+関税</td>
                    <td>Cpassデータから集計</td>
                </tr>
                <tr>
                    <td>Y</td>
                    <td>外注費(円)</td>
                    <td>*外注費(円)</td>
                    <td>旧：外注手数料</td>
                </tr>
                <tr>
                    <td>Z</td>
                    <td>発送方法</td>
                    <td>発送方法</td>
                    <td><span class="tag">新規</span></td>
                </tr>
                <tr>
                    <td>AA</td>
                    <td>追跡番号</td>
                    <td>追跡番号</td>
                    <td><span class="tag">新規</span> 送料集計のキー</td>
                </tr>
                <tr>
                    <td>AB</td>
                    <td>item_id</td>
                    <td>item_id</td>
                    <td><span class="tag">新規</span></td>
                </tr>
                <tr>
                    <td>AC</td>
                    <td>SKU</td>
                    <td>SKU</td>
                    <td><span class="tag">新規</span></td>
                </tr>
                <tr>
                    <td>AD</td>
                    <td>為替</td>
                    <td>為替</td>
                    <td><span class="tag">新規</span></td>
                </tr>
                <tr>
                    <td>AE</td>
                    <td>ドル為替</td>
                    <td>ドル為替</td>
                    <td><span class="tag">新規</span></td>
                </tr>
                <tr>
                    <td>AF</td>
                    <td>取消状態</td>
                    <td>取消状態</td>
                    <td><span class="tag">新規</span></td>
                </tr>
                <tr>
                    <td>AG</td>
                    <td>取消日時</td>
                    <td>取消日時</td>
                    <td><span class="tag">新規</span></td>
                </tr>
                <tr>
                    <td>AH</td>
                    <td>店舗id(仕入先)</td>
                    <td>店舗id(仕入先)</td>
                    <td><span class="tag">新規</span></td>
                </tr>
                <tr>
                    <td>AI</td>
                    <td>店舗名(仕入先)</td>
                    <td>店舗名(仕入先)</td>
                    <td><span class="tag">新規</span></td>
                </tr>
                <tr>
                    <td>AJ</td>
                    <td>粗利(円)</td>
                    <td>粗利(円)</td>
                    <td>計算列</td>
                </tr>
                <tr>
                    <td>AK</td>
                    <td>還付金</td>
                    <td>還付金</td>
                    <td>計算列</td>
                </tr>
                <tr>
                    <td>AL</td>
                    <td>利益合計</td>
                    <td>利益合計</td>
                    <td>計算列</td>
                </tr>
            </table>
        </div>

        <!-- 5. 送料集計シート -->
        <div class="section">
            <h2>5. 送料集計シート（新規）</h2>

            <h3>5-1. 送料系データ入力エリア</h3>
            <table>
                <tr>
                    <th>列</th>
                    <th>項目名</th>
                    <th>説明</th>
                </tr>
                <tr>
                    <td>A</td>
                    <td>請求書期日</td>
                    <td>Cpass請求期間</td>
                </tr>
                <tr>
                    <td>B</td>
                    <td>注文番号</td>
                    <td>追跡番号（集計キー）</td>
                </tr>
                <tr>
                    <td>C</td>
                    <td>費用タイプ</td>
                    <td>運送料金/燃料割増金/署名指定料等</td>
                </tr>
                <tr>
                    <td>D</td>
                    <td>金額</td>
                    <td>各費用の金額</td>
                </tr>
                <tr>
                    <td>E</td>
                    <td>取引時間</td>
                    <td>請求日時</td>
                </tr>
            </table>

            <h3>5-2. 関税系データ入力エリア</h3>
            <table>
                <tr>
                    <th>列</th>
                    <th>項目名</th>
                    <th>説明</th>
                </tr>
                <tr>
                    <td>G</td>
                    <td>請求期間</td>
                    <td>Cpass請求期間</td>
                </tr>
                <tr>
                    <td>H</td>
                    <td>注文番号</td>
                    <td>追跡番号（集計キー）</td>
                </tr>
                <tr>
                    <td>I</td>
                    <td>料金タイプ</td>
                    <td>推定関税/確定関税/控除等</td>
                </tr>
                <tr>
                    <td>J</td>
                    <td>小計(円)</td>
                    <td>各費用の金額（マイナスあり）</td>
                </tr>
                <tr>
                    <td>K</td>
                    <td>取引時間</td>
                    <td>請求日時</td>
                </tr>
            </table>

            <h3>5-3. 集計結果エリア</h3>
            <table>
                <tr>
                    <th>列</th>
                    <th>項目名</th>
                    <th>計算方法</th>
                </tr>
                <tr>
                    <td>M</td>
                    <td>追跡番号</td>
                    <td>ユニークな追跡番号一覧</td>
                </tr>
                <tr>
                    <td>N</td>
                    <td>送料系合計</td>
                    <td>=SUMIF(送料系データ, 追跡番号, 金額)</td>
                </tr>
                <tr>
                    <td>O</td>
                    <td>関税系合計</td>
                    <td>=SUMIF(関税系データ, 追跡番号, 小計)</td>
                </tr>
                <tr>
                    <td>P</td>
                    <td>送料+関税 合計</td>
                    <td>=送料系合計 + 関税系合計</td>
                </tr>
                <tr>
                    <td>Q</td>
                    <td>EAGLE登録済</td>
                    <td>チェックボックス or ✓</td>
                </tr>
                <tr>
                    <td>R</td>
                    <td>登録日</td>
                    <td>EAGLEに登録した日付</td>
                </tr>
            </table>

            <div class="highlight">
                <strong>費用タイプ一覧（送料系）</strong>
                <ul>
                    <li>運送料金</li>
                    <li>燃料割増金</li>
                    <li>署名指定料―成人による署名による調整</li>
                    <li>運送料金による調整</li>
                    <li>燃料割増金による調整</li>
                </ul>
            </div>

            <div class="highlight">
                <strong>料金タイプ一覧（関税系）</strong>
                <ul>
                    <li>推定米国関税及び税金料金</li>
                    <li>推定米国関税処理手数料</li>
                    <li>米国関税</li>
                    <li>米国関税処理手数料</li>
                    <li>推定米国関税及び税金料金に対する控除（マイナス）</li>
                    <li>推定米国関税処理手数料に対する控除（マイナス）</li>
                </ul>
            </div>
        </div>

        <!-- 6. GAS機能 -->
        <div class="section">
            <h2>6. GAS（Google Apps Script）機能</h2>

            <div class="card-grid">
                <div class="card">
                    <h4>機能1: CSV取り込み</h4>
                    <ul>
                        <li>送料系CSVを指定エリアに貼り付け</li>
                        <li>関税系CSVを指定エリアに貼り付け</li>
                        <li>自動で追跡番号ごとに集計</li>
                    </ul>
                </div>
                <div class="card">
                    <h4>機能2: 重複チェック</h4>
                    <ul>
                        <li>売上個別シートの追跡番号と突合</li>
                        <li>既に送料登録済みのものを検出</li>
                        <li>警告表示または自動スキップ</li>
                    </ul>
                </div>
                <div class="card">
                    <h4>機能3: EAGLE更新出力</h4>
                    <ul>
                        <li>未登録の追跡番号を抽出</li>
                        <li>「追跡番号, 送料+関税」形式で出力</li>
                        <li>クリップボードにコピー対応</li>
                    </ul>
                </div>
                <div class="card">
                    <h4>機能4: 登録済み管理</h4>
                    <ul>
                        <li>EAGLE登録後にチェックを入れる</li>
                        <li>登録日を自動記録</li>
                        <li>フィルタで未登録のみ表示</li>
                    </ul>
                </div>
            </div>

            <h3>カスタムメニュー</h3>
            <div class="code-block">
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('送料管理')
    .addItem('送料系CSVを集計', 'aggregateShippingCost')
    .addItem('関税系CSVを集計', 'aggregateDutyCost')
    .addSeparator()
    .addItem('重複チェック', 'checkDuplicates')
    .addItem('EAGLE更新用データ出力', 'exportForEagle')
    .addSeparator()
    .addItem('選択行を登録済みにする', 'markAsRegistered')
    .addToUi();
}
            </div>
        </div>

        <!-- 7. 運用フロー -->
        <div class="section">
            <h2>7. 運用フロー</h2>

            <h3>日常運用</h3>
            <table>
                <tr>
                    <th>Step</th>
                    <th>作業内容</th>
                    <th>使用ツール</th>
                </tr>
                <tr>
                    <td>1</td>
                    <td>EAGLEから売上データCSVをダウンロード</td>
                    <td>EAGLE</td>
                </tr>
                <tr>
                    <td>2</td>
                    <td>売上個別シートにCSVを貼り付け</td>
                    <td>スプレッドシート</td>
                </tr>
                <tr>
                    <td>3</td>
                    <td>Cpassから送料系CSVをダウンロード</td>
                    <td>Cpass</td>
                </tr>
                <tr>
                    <td>4</td>
                    <td>Cpassから関税系CSVをダウンロード</td>
                    <td>Cpass</td>
                </tr>
                <tr>
                    <td>5</td>
                    <td>送料集計シートにCSVを貼り付け</td>
                    <td>スプレッドシート</td>
                </tr>
                <tr>
                    <td>6</td>
                    <td>メニュー「重複チェック」を実行</td>
                    <td>GAS</td>
                </tr>
                <tr>
                    <td>7</td>
                    <td>メニュー「EAGLE更新用データ出力」を実行</td>
                    <td>GAS</td>
                </tr>
                <tr>
                    <td>8</td>
                    <td>EAGLEに送料データを一括登録</td>
                    <td>EAGLE</td>
                </tr>
                <tr>
                    <td>9</td>
                    <td>登録済みにチェックを入れる</td>
                    <td>スプレッドシート/GAS</td>
                </tr>
            </table>
        </div>

        <!-- 8. 実装優先度 -->
        <div class="section">
            <h2>8. 実装優先度</h2>

            <table>
                <tr>
                    <th>優先度</th>
                    <th>項目</th>
                    <th>理由</th>
                </tr>
                <tr>
                    <td><span class="status-badge" style="background:#dc3545;color:white;">高</span></td>
                    <td>売上個別シートの列構成変更</td>
                    <td>EAGLEのCSVをそのまま貼れるようにする</td>
                </tr>
                <tr>
                    <td><span class="status-badge" style="background:#dc3545;color:white;">高</span></td>
                    <td>送料集計シートの作成</td>
                    <td>Cpassデータの集計を自動化</td>
                </tr>
                <tr>
                    <td><span class="status-badge" style="background:#ffc107;color:black;">中</span></td>
                    <td>EAGLE更新用出力機能</td>
                    <td>手動コピペの手間を削減</td>
                </tr>
                <tr>
                    <td><span class="status-badge" style="background:#ffc107;color:black;">中</span></td>
                    <td>重複チェック機能</td>
                    <td>二重登録を防止</td>
                </tr>
                <tr>
                    <td><span class="status-badge" style="background:#28a745;color:white;">低</span></td>
                    <td>登録済み管理機能</td>
                    <td>運用で対応可能</td>
                </tr>
            </table>
        </div>

        <!-- 9. 確認事項 -->
        <div class="section">
            <h2>9. 確認事項（要検討）</h2>

            <div class="highlight">
                <strong>Q1:</strong> Sales Record Numberは今後も必要か？（EAGLEのCSVにはない）
            </div>
            <div class="highlight">
                <strong>Q2:</strong> 既存データの移行はどうするか？（新しい列構成への対応）
            </div>
            <div class="highlight">
                <strong>Q3:</strong> 計算列（粗利、還付金、利益合計）の計算式は現行のままでよいか？
            </div>
            <div class="highlight">
                <strong>Q4:</strong> 送料集計シートでユニークな追跡番号一覧はどう取得するか？（UNIQUE関数 or GAS）
            </div>
        </div>

        <!-- フッター -->
        <div class="section" style="text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <p>作成日: 2025年12月20日</p>
            <p>利益計算シート改修プロジェクト</p>
        </div>
    </div>
</body>
</html>
