<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>調整関税率計算ツール | V3対応</title>
    <style>
        :root {
            --primary: #1a73e8;
            --primary-dark: #1557b0;
            --success: #34a853;
            --warning: #ea8600;
            --danger: #d93025;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --text: #202124;
            --text-secondary: #5f6368;
            --border: #dadce0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: var(--primary);
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1em;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 24px;
            margin-bottom: 20px;
        }

        .card h2 {
            color: var(--primary);
            font-size: 1.2em;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary);
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text);
        }

        .hint {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        input[type="number"] {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            transition: border-color 0.2s;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: var(--primary);
        }

        .input-with-unit {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-with-unit input {
            flex: 1;
        }

        .unit {
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 30px;
        }

        .result-box {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 3px solid var(--success);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
        }

        .result-label {
            font-size: 1em;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .result-value {
            font-size: 3em;
            font-weight: 700;
            color: var(--success);
        }

        .result-unit {
            font-size: 1.5em;
            color: var(--text-secondary);
        }

        .formula-box {
            background: #fff3e0;
            border-left: 4px solid var(--warning);
            padding: 16px;
            border-radius: 0 8px 8px 0;
            margin-top: 20px;
        }

        .formula-box h3 {
            color: var(--warning);
            margin-bottom: 8px;
        }

        .formula {
            font-family: 'Consolas', 'Monaco', monospace;
            background: #fafafa;
            padding: 12px;
            border-radius: 6px;
            font-size: 0.95em;
            overflow-x: auto;
        }

        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 20px;
        }

        .comparison-item {
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }

        .comparison-item.before {
            background: #fce4ec;
            border: 2px solid #e91e63;
        }

        .comparison-item.after {
            background: #e3f2fd;
            border: 2px solid #2196f3;
        }

        .comparison-label {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .comparison-value {
            font-size: 1.8em;
            font-weight: 700;
        }

        .before .comparison-value {
            color: #c2185b;
        }

        .after .comparison-value {
            color: #1565c0;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid var(--primary);
            padding: 16px;
            border-radius: 0 8px 8px 0;
            margin-top: 20px;
        }

        .info-box h3 {
            color: var(--primary);
            margin-bottom: 8px;
        }

        .info-box ul {
            margin-left: 20px;
        }

        .info-box li {
            margin-bottom: 6px;
        }

        .copy-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em;
            margin-top: 12px;
            transition: background 0.2s;
        }

        .copy-btn:hover {
            background: var(--primary-dark);
        }

        .copy-btn.copied {
            background: var(--success);
        }

        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        footer a {
            color: var(--primary);
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 600px) {
            .comparison {
                grid-template-columns: 1fr;
            }

            .result-value {
                font-size: 2.5em;
            }

            .input-row {
                grid-template-columns: 1fr;
            }
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: normal;
            cursor: pointer;
        }

        .radio-group input[type="radio"] {
            width: auto;
        }

        .policy-result-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 3px solid #1565c0;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            margin-top: 20px;
        }

        .policy-result-value {
            font-size: 1em;
            font-weight: 700;
            color: #1565c0;
            margin-bottom: 8px;
            word-break: break-all;
            font-family: 'Courier New', monospace;
        }

        .shipping-method-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-top: 8px;
        }

        .badge-eco {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .badge-xp {
            background: #e3f2fd;
            color: #1565c0;
        }

        .badge-over {
            background: #ffebee;
            color: #c62828;
        }

        select {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            transition: border-color 0.2s;
            background: white;
        }

        select:focus {
            outline: none;
            border-color: var(--primary);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>調整関税率計算ツール</h1>
            <p class="subtitle">V3 DDP手数料対応版</p>
        </header>

        <div class="card">
            <h2>入力パラメータ</h2>

            <div class="input-row">
                <div class="form-group">
                    <label for="sellingPrice">販売価格</label>
                    <div class="input-with-unit">
                        <input type="number" id="sellingPrice" value="50" min="0" step="0.01">
                        <span class="unit">$</span>
                    </div>
                    <p class="hint">eBayでの販売価格（関税抜き）</p>
                </div>

                <div class="form-group">
                    <label for="tariffRate">実際の関税率</label>
                    <div class="input-with-unit">
                        <input type="number" id="tariffRate" value="15" min="0" max="100" step="0.1">
                        <span class="unit">%</span>
                    </div>
                    <p class="hint">例: 15% → 15 と入力</p>
                </div>
            </div>

            <div class="input-row">
                <div class="form-group">
                    <label for="feeRate">eBay手数料率</label>
                    <div class="input-with-unit">
                        <input type="number" id="feeRate" value="15" min="0" max="100" step="0.1">
                        <span class="unit">%</span>
                    </div>
                    <p class="hint">FVF（最終価値手数料）</p>
                </div>

                <div class="form-group">
                    <label for="adRate">広告費率</label>
                    <div class="input-with-unit">
                        <input type="number" id="adRate" value="5" min="0" max="100" step="0.1">
                        <span class="unit">%</span>
                    </div>
                    <p class="hint">Promoted Listings広告費</p>
                </div>
            </div>

            <div class="form-group">
                <label for="safetyMargin">安全係数</label>
                <div class="input-with-unit">
                    <input type="number" id="safetyMargin" value="3" min="0" max="20" step="0.1">
                    <span class="unit">%</span>
                </div>
                <p class="hint">端数・為替変動対策（推奨: 3%）</p>
            </div>

            <div class="input-row">
                <div class="form-group">
                    <label for="shippingMethod">配送方法</label>
                    <select id="shippingMethod">
                        <option value="eco">ECO（Economy）- DDP $0〜$440</option>
                        <option value="xp">XP（Express）- DDP $0〜$2519</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>商品状態</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="condition" value="new" checked>
                            新品 (new)
                        </label>
                        <label>
                            <input type="radio" name="condition" value="used">
                            中古 (used)
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>計算結果</h2>

            <div class="result-box">
                <div class="result-label">調整後の関税率</div>
                <div>
                    <span class="result-value" id="adjustedRate">20.1</span>
                    <span class="result-unit">%</span>
                </div>
                <button class="copy-btn" id="copyBtn" onclick="copyResult()">コピー</button>
            </div>

            <div class="comparison">
                <div class="comparison-item before">
                    <div class="comparison-label">実際の関税率</div>
                    <div class="comparison-value" id="originalRate">15.0%</div>
                </div>
                <div class="comparison-item after">
                    <div class="comparison-label">調整後の関税率</div>
                    <div class="comparison-value" id="adjustedRateCompare">20.1%</div>
                </div>
            </div>

            <div class="formula-box">
                <h3>計算式</h3>
                <div class="formula" id="formulaDisplay">
                    調整関税率 = 15% ÷ (1 - 0.15 - 0.05) × 1.03 = 19.3%
                </div>
            </div>

            <div class="policy-result-box">
                <div class="result-label">推奨シッピングポリシー</div>
                <div class="policy-result-value" id="recommendedPolicy">-</div>
                <div id="shippingBadge"></div>
                <div style="font-size: 0.9em; color: #5f6368; margin-top: 12px;">
                    DDP価格: <strong id="ddpPrice">-</strong> ｜
                    関税額: <strong id="estimatedTariff">-</strong>
                </div>
                <button class="copy-btn" id="copyPolicyBtn" onclick="copyPolicy()">ポリシー名をコピー</button>
            </div>
        </div>

        <div class="card">
            <h2>使い方</h2>

            <div class="info-box">
                <h3>調整関税率とは？</h3>
                <p>eBayがDDP価格（関税込み価格）に対して手数料を課すようになったため、
                関税額にも手数料がかかります。この手数料分を補填するために、
                実際の関税率より高い「調整関税率」を使用して関税額を計算します。</p>
            </div>

            <div class="info-box" style="margin-top: 16px;">
                <h3>配送方法について</h3>
                <ul>
                    <li><strong>ECO（Economy）</strong>: DDP価格 $0〜$440 に対応</li>
                    <li><strong>XP（Express）</strong>: DDP価格 $0〜$2519 に対応</li>
                    <li>DDP価格が選択した配送方法の範囲を超える場合はエラーが表示されます</li>
                </ul>
            </div>

            <div class="info-box" style="margin-top: 16px;">
                <h3>一括シートでの設定</h3>
                <ul>
                    <li><strong>AA2セル</strong>: 実際の関税率（例: 0.15 = 15%）</li>
                    <li><strong>AF2セル</strong>: 調整関税率（自動計算）</li>
                    <li>初期設定を実行すると、AF2に計算式が自動設定されます</li>
                </ul>
            </div>
        </div>

        <footer>
            <p>
                <a href="ver44-update.html">&larr; V3 更新内容に戻る</a>
            </p>
            <p style="margin-top: 10px;">
                一括シートV3 | DDP手数料対応版
            </p>
        </footer>
    </div>

    <script>
        // ECOポリシーデータ（DDU価格下限-上限、関税額）
        // 判定は関税額で行う。DDU範囲は表示用
        const ecoPolicies = [
            { minDDU: 0, maxDDU: 7, tariff: 3 },
            { minDDU: 7, maxDDU: 13, tariff: 4 },
            { minDDU: 13, maxDDU: 20, tariff: 5 },
            { minDDU: 20, maxDDU: 26, tariff: 6 },
            { minDDU: 26, maxDDU: 33, tariff: 7 },
            { minDDU: 33, maxDDU: 40, tariff: 8 },
            { minDDU: 40, maxDDU: 46, tariff: 9 },
            { minDDU: 46, maxDDU: 52, tariff: 10 },
            { minDDU: 52, maxDDU: 59, tariff: 11 },
            { minDDU: 59, maxDDU: 65, tariff: 12 },
            { minDDU: 65, maxDDU: 72, tariff: 13 },
            { minDDU: 72, maxDDU: 78, tariff: 14 },
            { minDDU: 78, maxDDU: 85, tariff: 15 },
            { minDDU: 85, maxDDU: 91, tariff: 16 },
            { minDDU: 91, maxDDU: 97, tariff: 17 },
            { minDDU: 97, maxDDU: 104, tariff: 18 },
            { minDDU: 104, maxDDU: 110, tariff: 19 },
            { minDDU: 110, maxDDU: 117, tariff: 20 },
            { minDDU: 117, maxDDU: 130, tariff: 22 },
            { minDDU: 130, maxDDU: 143, tariff: 24 },
            { minDDU: 143, maxDDU: 150, tariff: 25 },
            { minDDU: 150, maxDDU: 156, tariff: 26 },
            { minDDU: 156, maxDDU: 169, tariff: 28 },
            { minDDU: 169, maxDDU: 181, tariff: 30 },
            { minDDU: 181, maxDDU: 194, tariff: 32 },
            { minDDU: 194, maxDDU: 207, tariff: 34 },
            { minDDU: 207, maxDDU: 214, tariff: 35 },
            { minDDU: 214, maxDDU: 227, tariff: 37 },
            { minDDU: 227, maxDDU: 246, tariff: 40 },
            { minDDU: 246, maxDDU: 259, tariff: 42 },
            { minDDU: 259, maxDDU: 278, tariff: 45 },
            { minDDU: 278, maxDDU: 291, tariff: 47 },
            { minDDU: 291, maxDDU: 311, tariff: 50 },
            { minDDU: 311, maxDDU: 324, tariff: 52 },
            { minDDU: 324, maxDDU: 343, tariff: 55 },
            { minDDU: 343, maxDDU: 356, tariff: 57 },
            { minDDU: 356, maxDDU: 375, tariff: 60 },
            { minDDU: 375, maxDDU: 407, tariff: 65 },
            { minDDU: 407, maxDDU: 440, tariff: 70 }
        ];

        // XPポリシーデータ（DDU価格下限-上限、関税額）
        const xpPolicies = [
            { minDDU: 0, maxDDU: 45, tariff: 7 },
            { minDDU: 45, maxDDU: 52, tariff: 8 },
            { minDDU: 52, maxDDU: 58, tariff: 9 },
            { minDDU: 58, maxDDU: 65, tariff: 10 },
            { minDDU: 65, maxDDU: 71, tariff: 11 },
            { minDDU: 71, maxDDU: 78, tariff: 12 },
            { minDDU: 78, maxDDU: 84, tariff: 13 },
            { minDDU: 84, maxDDU: 90, tariff: 14 },
            { minDDU: 90, maxDDU: 97, tariff: 15 },
            { minDDU: 97, maxDDU: 103, tariff: 16 },
            { minDDU: 103, maxDDU: 110, tariff: 17 },
            { minDDU: 110, maxDDU: 116, tariff: 18 },
            { minDDU: 116, maxDDU: 123, tariff: 19 },
            { minDDU: 123, maxDDU: 129, tariff: 20 },
            { minDDU: 129, maxDDU: 142, tariff: 22 },
            { minDDU: 142, maxDDU: 155, tariff: 24 },
            { minDDU: 155, maxDDU: 161, tariff: 25 },
            { minDDU: 161, maxDDU: 168, tariff: 26 },
            { minDDU: 168, maxDDU: 181, tariff: 28 },
            { minDDU: 181, maxDDU: 194, tariff: 30 },
            { minDDU: 194, maxDDU: 207, tariff: 32 },
            { minDDU: 207, maxDDU: 220, tariff: 34 },
            { minDDU: 220, maxDDU: 226, tariff: 35 },
            { minDDU: 226, maxDDU: 239, tariff: 37 },
            { minDDU: 239, maxDDU: 258, tariff: 40 },
            { minDDU: 258, maxDDU: 271, tariff: 42 },
            { minDDU: 271, maxDDU: 291, tariff: 45 },
            { minDDU: 291, maxDDU: 304, tariff: 47 },
            { minDDU: 304, maxDDU: 323, tariff: 50 },
            { minDDU: 323, maxDDU: 336, tariff: 52 },
            { minDDU: 336, maxDDU: 355, tariff: 55 },
            { minDDU: 355, maxDDU: 368, tariff: 57 },
            { minDDU: 368, maxDDU: 388, tariff: 60 },
            { minDDU: 388, maxDDU: 420, tariff: 65 },
            { minDDU: 420, maxDDU: 452, tariff: 70 },
            { minDDU: 452, maxDDU: 484, tariff: 75 },
            { minDDU: 484, maxDDU: 517, tariff: 80 },
            { minDDU: 517, maxDDU: 549, tariff: 85 },
            { minDDU: 549, maxDDU: 581, tariff: 90 },
            { minDDU: 581, maxDDU: 614, tariff: 95 },
            { minDDU: 614, maxDDU: 646, tariff: 100 },
            { minDDU: 646, maxDDU: 678, tariff: 105 },
            { minDDU: 678, maxDDU: 710, tariff: 110 },
            { minDDU: 710, maxDDU: 743, tariff: 115 },
            { minDDU: 743, maxDDU: 775, tariff: 120 },
            { minDDU: 775, maxDDU: 807, tariff: 125 },
            { minDDU: 807, maxDDU: 840, tariff: 130 },
            { minDDU: 840, maxDDU: 872, tariff: 135 },
            { minDDU: 872, maxDDU: 904, tariff: 140 },
            { minDDU: 904, maxDDU: 937, tariff: 145 },
            { minDDU: 937, maxDDU: 969, tariff: 150 },
            { minDDU: 969, maxDDU: 1001, tariff: 155 },
            { minDDU: 1001, maxDDU: 1033, tariff: 160 },
            { minDDU: 1033, maxDDU: 1066, tariff: 165 },
            { minDDU: 1066, maxDDU: 1098, tariff: 170 },
            { minDDU: 1098, maxDDU: 1130, tariff: 175 },
            { minDDU: 1130, maxDDU: 1163, tariff: 180 },
            { minDDU: 1163, maxDDU: 1195, tariff: 185 },
            { minDDU: 1195, maxDDU: 1227, tariff: 190 },
            { minDDU: 1227, maxDDU: 1259, tariff: 195 },
            { minDDU: 1259, maxDDU: 1292, tariff: 200 },
            { minDDU: 1292, maxDDU: 1324, tariff: 205 },
            { minDDU: 1324, maxDDU: 1356, tariff: 210 },
            { minDDU: 1356, maxDDU: 1389, tariff: 215 },
            { minDDU: 1389, maxDDU: 1421, tariff: 220 },
            { minDDU: 1421, maxDDU: 1453, tariff: 225 },
            { minDDU: 1453, maxDDU: 1486, tariff: 230 },
            { minDDU: 1486, maxDDU: 1518, tariff: 235 },
            { minDDU: 1518, maxDDU: 1550, tariff: 240 },
            { minDDU: 1550, maxDDU: 1582, tariff: 245 },
            { minDDU: 1582, maxDDU: 1615, tariff: 250 },
            { minDDU: 1615, maxDDU: 1647, tariff: 255 },
            { minDDU: 1647, maxDDU: 1679, tariff: 260 },
            { minDDU: 1679, maxDDU: 1712, tariff: 265 },
            { minDDU: 1712, maxDDU: 1744, tariff: 270 },
            { minDDU: 1744, maxDDU: 1776, tariff: 275 },
            { minDDU: 1776, maxDDU: 1808, tariff: 280 },
            { minDDU: 1808, maxDDU: 1841, tariff: 285 },
            { minDDU: 1841, maxDDU: 1873, tariff: 290 },
            { minDDU: 1873, maxDDU: 1905, tariff: 295 },
            { minDDU: 1905, maxDDU: 1938, tariff: 300 },
            { minDDU: 1938, maxDDU: 1970, tariff: 305 },
            { minDDU: 1970, maxDDU: 2002, tariff: 310 },
            { minDDU: 2002, maxDDU: 2034, tariff: 315 },
            { minDDU: 2034, maxDDU: 2067, tariff: 320 },
            { minDDU: 2067, maxDDU: 2099, tariff: 325 },
            { minDDU: 2099, maxDDU: 2131, tariff: 330 },
            { minDDU: 2131, maxDDU: 2164, tariff: 335 },
            { minDDU: 2164, maxDDU: 2196, tariff: 340 },
            { minDDU: 2196, maxDDU: 2228, tariff: 345 },
            { minDDU: 2228, maxDDU: 2261, tariff: 350 },
            { minDDU: 2261, maxDDU: 2293, tariff: 355 },
            { minDDU: 2293, maxDDU: 2325, tariff: 360 },
            { minDDU: 2325, maxDDU: 2357, tariff: 365 },
            { minDDU: 2357, maxDDU: 2390, tariff: 370 },
            { minDDU: 2390, maxDDU: 2422, tariff: 375 },
            { minDDU: 2422, maxDDU: 2454, tariff: 380 },
            { minDDU: 2454, maxDDU: 2487, tariff: 385 },
            { minDDU: 2487, maxDDU: 2519, tariff: 390 }
        ];

        // 入力要素
        const sellingPriceInput = document.getElementById('sellingPrice');
        const tariffRateInput = document.getElementById('tariffRate');
        const feeRateInput = document.getElementById('feeRate');
        const adRateInput = document.getElementById('adRate');
        const safetyMarginInput = document.getElementById('safetyMargin');
        const shippingMethodSelect = document.getElementById('shippingMethod');

        // 結果表示要素
        const adjustedRateEl = document.getElementById('adjustedRate');
        const originalRateEl = document.getElementById('originalRate');
        const adjustedRateCompareEl = document.getElementById('adjustedRateCompare');
        const formulaDisplayEl = document.getElementById('formulaDisplay');
        const recommendedPolicyEl = document.getElementById('recommendedPolicy');
        const ddpPriceEl = document.getElementById('ddpPrice');
        const estimatedTariffEl = document.getElementById('estimatedTariff');
        const shippingBadgeEl = document.getElementById('shippingBadge');

        // 関税額からポリシーを検索（関税額が一致するポリシーを探す）
        function findPolicyByTariff(policies, estimatedTariff) {
            for (const policy of policies) {
                if (policy.tariff === estimatedTariff) {
                    return policy;
                }
            }
            return null;
        }

        // ポリシー名を生成
        function generatePolicyName(policy, shippingMethod, condition) {
            const minStr = String(policy.minDDU).padStart(4, '0');
            const maxStr = String(policy.maxDDU).padStart(4, '0');
            const tariffStr = String(policy.tariff).padStart(4, '0');
            return `Egl_2511-${minStr}-${maxStr}_${shippingMethod}_${condition}_${tariffStr}`;
        }

        // 計算関数
        function calculate() {
            const sellingPrice = parseFloat(sellingPriceInput.value) || 0;
            const tariffRate = parseFloat(tariffRateInput.value) / 100 || 0;
            const feeRate = parseFloat(feeRateInput.value) / 100 || 0;
            const adRate = parseFloat(adRateInput.value) / 100 || 0;
            const safetyMargin = parseFloat(safetyMarginInput.value) / 100 || 0;
            const shippingMethod = shippingMethodSelect.value;
            const condition = document.querySelector('input[name="condition"]:checked').value;

            // 調整関税率 = 実際の関税率 / (1 - 手数料率 - 広告費率) × (1 + 安全係数)
            const denominator = 1 - feeRate - adRate;
            let adjustedRate = 0;

            if (denominator > 0) {
                adjustedRate = (tariffRate / denominator) * (1 + safetyMargin);
            }

            // 表示更新
            const adjustedPercent = (adjustedRate * 100).toFixed(1);
            const originalPercent = (tariffRate * 100).toFixed(1);

            adjustedRateEl.textContent = adjustedPercent;
            originalRateEl.textContent = originalPercent + '%';
            adjustedRateCompareEl.textContent = adjustedPercent + '%';

            // 計算式の表示
            const safetyFactor = (1 + safetyMargin).toFixed(2);
            formulaDisplayEl.textContent =
                `調整関税率 = ${originalPercent}% ÷ (1 - ${(feeRate * 100).toFixed(0)/100} - ${(adRate * 100).toFixed(0)/100}) × ${safetyFactor} = ${adjustedPercent}%`;

            // 関税額を計算（四捨五入して整数に）
            const estimatedTariff = Math.round(sellingPrice * adjustedRate);

            // DDP価格を計算（整数）
            const ddpPrice = Math.round(sellingPrice + estimatedTariff);

            // ポリシーを判定（関税額で検索）
            const policies = shippingMethod === 'eco' ? ecoPolicies : xpPolicies;
            const maxTariff = shippingMethod === 'eco' ? 70 : 390;
            const minTariff = shippingMethod === 'eco' ? 3 : 7;

            let recommendedPolicy = '-';
            let foundPolicy = findPolicyByTariff(policies, estimatedTariff);

            if (foundPolicy) {
                recommendedPolicy = generatePolicyName(foundPolicy, shippingMethod, condition);
            } else if (estimatedTariff > maxTariff) {
                recommendedPolicy = `範囲外（関税額 $${estimatedTariff} > $${maxTariff}）`;
            } else if (estimatedTariff < minTariff) {
                recommendedPolicy = `範囲外（関税額 $${estimatedTariff} < $${minTariff}）`;
            } else {
                recommendedPolicy = `該当ポリシーなし（関税額 $${estimatedTariff}）`;
            }

            // 表示更新
            recommendedPolicyEl.textContent = recommendedPolicy;
            ddpPriceEl.textContent = '$' + ddpPrice;
            estimatedTariffEl.textContent = '$' + estimatedTariff;

            // バッジ表示
            if (foundPolicy && shippingMethod === 'eco') {
                shippingBadgeEl.innerHTML = '<span class="shipping-method-badge badge-eco">ECO（Economy）</span>';
            } else if (foundPolicy && shippingMethod === 'xp') {
                shippingBadgeEl.innerHTML = '<span class="shipping-method-badge badge-xp">XP（Express）</span>';
            } else {
                shippingBadgeEl.innerHTML = '<span class="shipping-method-badge badge-over">範囲外</span>';
            }
        }

        // コピー機能
        function copyResult() {
            const value = adjustedRateEl.textContent;
            const decimalValue = (parseFloat(value) / 100).toFixed(4);

            navigator.clipboard.writeText(decimalValue).then(() => {
                const btn = document.getElementById('copyBtn');
                btn.textContent = 'コピーしました！';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'コピー';
                    btn.classList.remove('copied');
                }, 2000);
            });
        }

        // ポリシー名コピー機能
        function copyPolicy() {
            const policyName = recommendedPolicyEl.textContent;
            if (policyName === '-' || policyName.includes('範囲外')) return;

            navigator.clipboard.writeText(policyName).then(() => {
                const btn = document.getElementById('copyPolicyBtn');
                btn.textContent = 'コピーしました！';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'ポリシー名をコピー';
                    btn.classList.remove('copied');
                }, 2000);
            });
        }

        // イベントリスナー
        [sellingPriceInput, tariffRateInput, feeRateInput, adRateInput, safetyMarginInput, shippingMethodSelect].forEach(input => {
            input.addEventListener('input', calculate);
            input.addEventListener('change', calculate);
        });

        document.querySelectorAll('input[name="condition"]').forEach(radio => {
            radio.addEventListener('change', calculate);
        });

        // 初期計算
        calculate();
    </script>
</body>
</html>
